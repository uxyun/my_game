<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>タイミングタップゲーム</title>
<style>
  body, html {
    margin:0; padding:0; overflow:hidden;
    background: #222;
    color: #fff;
    font-family: sans-serif;
    user-select: none;
    -webkit-user-select: none;
    touch-action: manipulation;
  }
  #gameArea {
    position: relative;
    width: 100vw; height: 100vh;
    overflow: hidden;
    background: #000;
  }
  #target {
    position: absolute;
    top: 50%;
    width: 80px;
    height: 80px;
    transform: translateY(-50%);
    transition: box-shadow 0.2s ease;
  }
  #target.glow {
    box-shadow: 0 0 15px 8px #fff;
  }
  #score {
    position: absolute;
    top: 20px; left: 20px;
    font-size: 24px;
    font-weight: bold;
  }
  #message {
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    font-size: 28px;
    color: #0f0;
    display: none;
  }
</style>
</head>
<body>

<div id="gameArea">
  <img id="target" src="player.png" alt="的" style="left: 100vw;">
  <div id="score">Score: 0</div>
  <div id="message">ゲーム終了！</div>
</div>

<audio id="bgm" src="bgm.mp3"></audio>

<script>
(() => {
  const target = document.getElementById('target');
  const scoreDisplay = document.getElementById('score');
  const message = document.getElementById('message');
  const bgm = document.getElementById('bgm');

  let score = 0;
  let gameRunning = false;

  // 的の移動パラメータ
  const speed = 200; // px/秒
  const targetWidth = 80;

  let startTime = 0;
  let animationFrameId = null;

  // 的の初期位置：画面右端の外
  function resetTarget() {
    target.style.left = window.innerWidth + 'px';
    target.classList.remove('glow');
  }

  // タップ判定の範囲(px)
  const hitRange = 40;

  // ゲーム開始
  function startGame() {
    score = 0;
    scoreDisplay.textContent = 'Score: 0';
    message.style.display = 'none';
    resetTarget();
    startTime = performance.now();
    gameRunning = true;

    // BGMを再生
    bgm.currentTime = 0;
    bgm.play().catch(() => {
      // iPhoneは自動再生できないので、最初のタップまで待つ
      console.log('BGM再生にユーザー操作が必要です');
    });

    // 移動開始
    animationFrameId = requestAnimationFrame(gameLoop);
  }

  // ゲーム終了処理
  function endGame() {
    gameRunning = false;
    cancelAnimationFrame(animationFrameId);
    message.style.display = 'block';
  }

  // ゲームループ（的を左へ移動）
  function gameLoop(timestamp) {
    if (!startTime) startTime = timestamp;
    const elapsed = (timestamp - startTime) / 1000; // 秒経過

    // 的の現在X座標（右端から左へ）
    let posX = window.innerWidth - elapsed * speed;

    if (posX < -targetWidth) {
      // 的が画面外左へ抜けたらリセット（次の的を出す）
      startTime = timestamp;
      posX = window.innerWidth;
      target.classList.remove('glow');
    }

    target.style.left = posX + 'px';

    if (gameRunning) {
      animationFrameId = requestAnimationFrame(gameLoop);
    }
  }

  // タップ時の判定
  function onTap(evt) {
    if (!gameRunning) {
      startGame();
      return;
    }

    // タップ座標取得
    let tapX = evt.touches ? evt.touches[0].clientX : evt.clientX;

    // 的の位置と判定
    const targetRect = target.getBoundingClientRect();
    const targetCenterX = targetRect.left + targetRect.width / 2;

    // 判定範囲内ならヒット
    if (Math.abs(tapX - targetCenterX) <= hitRange) {
      score++;
      scoreDisplay.textContent = 'Score: ' + score;

      // 光らせる
      target.classList.add('glow');
      setTimeout(() => {
        target.classList.remove('glow');
      }, 200);
    }
  }

  // BGM終了でゲーム終了
  bgm.addEventListener('ended', () => {
    endGame();
  });

  // 初回は画面タップでゲームスタート
  document.getElementById('gameArea').addEventListener('click', onTap);
  document.getElementById('gameArea').addEventListener('touchstart', onTap);

  // 画面リサイズ時の的再配置
  window.addEventListener('resize', () => {
    if (gameRunning) resetTarget();
  });

  // 最初はゲーム開始せず、タップでスタートを待つ
  message.textContent = '画面タップでスタート';
  message.style.display = 'block';
})();
</script>

</body>
</html>
