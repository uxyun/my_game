<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>BlizzardK Shooting</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #222; }
    #gameContainer { width: 100vw; height: 100vh; }
    canvas { touch-action: none; }
  </style>
</head>
<body>
  <div id="gameContainer"></div>
  <script>
    const config = {
      type: Phaser.AUTO,
      scale: {
        mode: Phaser.Scale.RESIZE,
        parent: 'gameContainer',
        width: window.innerWidth,
        height: window.innerHeight,
      },
      physics: { default: 'arcade', arcade: { debug: false } },
      scene: { preload, create, update }
    };

    let game = new Phaser.Game(config);
    let player, bullets, enemies, cursors;
    let score = 0;
    let scoreText, timerText;
    let timeLeft = 30;
    let bgm;
    let leftPressed = false;
    let rightPressed = false;
    const enemyChars = ['B', 'l', 'i', 'z', 'z', 'a', 'r', 'd', 'K'];

    function preload() {
      this.load.image('playerFace', 'player.png');
      this.load.image('bullet', 'https://labs.phaser.io/assets/sprites/bullet.png');
      this.load.audio('bgm', 'bgm.mp3');
    }

    function create() {
      const centerX = this.scale.width / 2;
      const bottomY = this.scale.height - 50;
      player = this.physics.add.sprite(centerX, bottomY, 'playerFace').setScale(0.3);
      player.setCollideWorldBounds(true);
      bullets = this.physics.add.group({ defaultKey: 'bullet', maxSize: 10 });
      enemies = this.physics.add.group();
      cursors = this.input.keyboard.createCursorKeys();
      scoreText = this.add.text(10, 10, 'Score: 0', { fontSize: '20px', fill: '#fff' });
      timerText = this.add.text(this.scale.width - 120, 10, 'Time: 30', { fontSize: '20px', fill: '#fff' });

      this.time.addEvent({ delay: 1000, callback: () => {
        timeLeft--;
        timerText.setText('Time: ' + timeLeft);
        if (timeLeft <= 0) endGame(this);
      }, loop: true });

      this.time.addEvent({ delay: 1000, callback: () => spawnEnemy(this), loop: true });
      this.time.addEvent({ delay: 500, callback: () => shootBullet(this), loop: true });
      this.physics.add.overlap(bullets, enemies, hitEnemy, null, this);

      bgm = this.sound.add('bgm', { loop: true, volume: 0.5 });
      bgm.play();

      this.input.on('pointerdown', (pointer) => {
        if (pointer.x < this.scale.width / 2) leftPressed = true;
        else rightPressed = true;
      });
      this.input.on('pointerup', () => {
        leftPressed = false;
        rightPressed = false;
      });
    }

    function update() {
      if (leftPressed) player.setVelocityX(-200);
      else if (rightPressed) player.setVelocityX(200);
      else if (cursors.left.isDown) player.setVelocityX(-200);
      else if (cursors.right.isDown) player.setVelocityX(200);
      else player.setVelocityX(0);

      bullets.children.each(b => {
        if (b.active && b.y < 0) b.setActive(false).setVisible(false).body.enable = false;
      });

      enemies.children.each(e => {
        if (e.active && e.y > game.scale.height + 50) {
          e.setActive(false).setVisible(false).body.enable = false;
          e.destroy();
        }
      });
    }

    function spawnEnemy(scene) {
      let x = Phaser.Math.Between(40, scene.scale.width - 40);
      let char = Phaser.Utils.Array.GetRandom(enemyChars);
      let text = scene.add.text(0, 0, char, {
        fontSize: '32px',
        fill: (char === 'K') ? '#ff4444' : '#ffffff'
      });

      let box = scene.add.rectangle(0, 0, text.width, text.height, 0x000000, 0); // ÈÄèÊòé„ÅÆ„Éí„ÉÉ„Éà„Éú„ÉÉ„ÇØ„Çπ
      let container = scene.add.container(x, 0, [box, text]);
      scene.physics.add.existing(container);
      container.body.setVelocityY(100);
      container.char = char;
      enemies.add(container);
    }

    function shootBullet(scene) {
      let bullet = bullets.get(player.x, player.y - 20);
      if (bullet) {
        bullet.setActive(true).setVisible(true).body.enable = true;
        bullet.setVelocityY(-300);
      }
    }

    function hitEnemy(bullet, enemy) {
      bullet.setActive(false).setVisible(false).body.enable = false;
      enemy.setActive(false).setVisible(false).body.enable = false;
      enemy.destroy();
      score += (enemy.char === 'K') ? 100 : 10;
      scoreText.setText('Score: ' + score);
    }

    function endGame(scene) {
      scene.physics.pause();
      bgm.stop();
      const playerName = prompt('„Ç≤„Éº„É†ÁµÇ‰∫ÜÔºÅÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶„Å≠Ôºö', 'Player');
      if (playerName) saveScore(playerName, score);
      showRanking(scene);
    }

    function saveScore(name, score) {
      let records = JSON.parse(localStorage.getItem('shooting_ranking')) || [];
      records.push({ name, score });
      records.sort((a, b) => b.score - a.score);
      records = records.slice(0, 5);
      localStorage.setItem('shooting_ranking', JSON.stringify(records));
    }

    function showRanking(scene) {
      let records = JSON.parse(localStorage.getItem('shooting_ranking')) || [];
      let y = 200;
      scene.add.text(100, y - 40, 'üèÜ „É©„É≥„Ç≠„É≥„Ç∞ üèÜ', { fontSize: '24px', fill: '#ff0' });
      records.forEach((entry, i) => {
        scene.add.text(100, y + i * 30, `${i + 1}. ${entry.name} - ${entry.score}ÁÇπ`, {
          fontSize: '20px', fill: '#fff'
        });
      });
      scene.add.text(100, y + records.length * 30 + 40, '„É™„É≠„Éº„Éâ„ÅßÂÜç„Éó„É¨„Ç§', {
        fontSize: '16px', fill: '#aaa'
      });
    }
  </script>
</body>
</html>
